# Comprehensive Guide to Recreating the Recipe API

This document provides exhaustive instructions for replicating the Recipe API application. It details the architecture, required dependencies, setup procedures, database configuration, authentication mechanisms, recipe management features, and other essential components. Adhering strictly to these steps will ensure a fully functional replica of the original application.

## Table of Contents
1.  [Project Overview](#project-overview)
2.  [Technology Stack & Dependencies](#technology-stack--dependencies)
3.  [Project Setup](#project-setup)
4.  [Application Architecture](#application-architecture)
5.  [Environment Configuration](#environment-configuration)
6.  [Database Setup & Migrations](#database-setup--migrations)
7.  [Core Implementation Details](#core-implementation-details)
    *   [Server Entry Point (`server.ts`)](#server-entry-point-serverts)
    *   [Application Setup (`app.ts`)](#application-setup-appts)
    *   [Configuration (`config/index.ts`)](#configuration-configindexts)
    *   [Authentication System](#authentication-system)
    *   [Recipe Management System](#recipe-management-system)
    *   [Middleware Implementation](#middleware-implementation)
    *   [Error Handling](#error-handling)
    *   [Logging](#logging)
8.  [API Documentation (Swagger)](#api-documentation-swagger)
9.  [Running the Application](#running-the-application)
10. [Utility Scripts](#utility-scripts)

## Project Overview

The Recipe API is a Node.js-based RESTful service built with Express and TypeScript. It facilitates recipe management, including user authentication, CRUD operations for recipes, handling ingredients and instructions, and managing recipe photos. It utilizes a PostgreSQL database and provides API documentation via Swagger.

## Technology Stack & Dependencies

### Core Technologies:
*   **Runtime:** Node.js (>=16.0.0)
*   **Language:** TypeScript (~5.8.2)
*   **Framework:** Express (~5.1.0)
*   **Database:** PostgreSQL

### Production Dependencies (`dependencies` in `package.json`):
*   `bcrypt`: ^5.1.1 (Password hashing)
*   `class-validator`: ^0.14.1 (DTO validation)
*   `compression`: ^1.8.0 (Response compression)
*   `cookie-parser`: ^1.4.7 (Cookie parsing)
*   `cors`: ^2.8.5 (Cross-Origin Resource Sharing)
*   `dotenv`: ^16.5.0 (Environment variable loading)
*   `envalid`: ^8.0.0 (Environment variable validation)
*   `express`: ^5.1.0 (Web framework)
*   `express-rate-limit`: ^7.5.0 (Rate limiting)
*   `helmet`: ^8.1.0 (Security headers)
*   `hpp`: ^0.2.3 (HTTP Parameter Pollution protection)
*   `jsonwebtoken`: ^9.0.2 (JWT handling)
*   `mkdirp`: ^0.5.1 (Directory creation utility - likely for migrations or logs)
*   `morgan`: ^1.10.0 (HTTP request logging)
*   `multer`: ^1.4.5-lts.2 (File upload handling)
*   `pg`: ^8.14.1 (PostgreSQL client)
*   `pg-format`: ^1.0.4 (SQL query formatting)
*   `pg-pool`: ^3.8.0 (PostgreSQL connection pooling - though direct client seems used)
*   `pg-types`: ^4.0.2 (PostgreSQL type parsing)
*   `rimraf`: ^2.6.2 (Deep deletion utility - likely for build cleanup)
*   `swagger-jsdoc`: ^6.2.8 (Swagger definition generation)
*   `swagger-ui-express`: ^5.0.1 (Swagger UI middleware)
*   `typedi`: ^0.10.0 (Dependency Injection - usage not confirmed in provided files)
*   `uuid`: ^11.1.0 (UUID generation)
*   `winston`: ^3.17.0 (Logging library)
*   `winston-daily-rotate-file`: ^5.0.0 (Log rotation for Winston)
*   `zod`: ^3.24.3 (Schema validation - used in DTOs)

### Development Dependencies (`devDependencies` in `package.json`):
*   `@eslint/js`: ^9.13.0
*   `@stylistic/eslint-plugin`: ^2.9.0
*   `@types/*`: Various type definitions for libraries
*   `cross-env`: ^7.0.3 (Set environment variables cross-platform)
*   `eslint`: ^9.13.0 (Linter)
*   `node-pg-migrate`: ^7.9.1 (Database migration tool)
*   `nodemon`: ^3.1.9 (Development server auto-restart)
*   `ts-node`: ^10.9.2 (Run TypeScript directly)
*   `typescript`: ^5.8.2 (TypeScript compiler)
*   `typescript-eslint`: ^8.26.0 (ESLint plugin for TypeScript)

## Project Setup

1.  **Prerequisites:**
    *   Node.js (>= v16.0.0) installed.
    *   PostgreSQL server running.
    *   Git (optional).

2.  **Initialize Project:**
    ```bash
    git clone <repository_url> recipe-api # Or mkdir recipe-api && cd recipe-api
    cd recipe-api
    npm install
    ```
    This installs all dependencies listed in `package.json`.

3.  **Directory Structure:** Ensure the project has the following structure (key directories):
    ```
    recipe-api/
    ├── migrations/         # Database migration files (generated by node-pg-migrate)
    ├── src/
    │   ├── config/         # Environment variable configuration
    │   ├── controllers/    # Request handlers
    │   ├── database/       # Database connection, migration config/runner
    │   ├── dto/            # Data Transfer Objects (with validation)
    │   ├── exceptions/     # Custom error classes
    │   ├── interfaces/     # TypeScript interfaces
    │   ├── logs/           # Log files (auto-generated)
    │   ├── middlewares/    # Express middleware
    │   ├── routes/         # API route definitions
    │   ├── scripts/        # Helper scripts (migrations, seeding)
    │   ├── services/       # Business logic
    │   ├── types/          # Custom type definitions (e.g., extending Express Request)
    │   └── utils/          # Utility functions (logger, etc.)
    ├── uploads/            # Directory for uploaded files (needs to be created manually or by the app)
    ├── .env.*.local        # Environment configuration files (e.g., .env.development.local)
    ├── eslint.config.mjs   # ESLint configuration
    ├── nodemon.json        # Nodemon configuration
    ├── package.json        # Project manifest and dependencies
    ├── tsconfig.json       # TypeScript compiler options
    └── README.md           # Project documentation
    ```

4.  **TypeScript Configuration (`tsconfig.json`):**
    ```json
    {
      "compilerOptions": {
        "target": "ES2020",             # Target modern ECMAScript version
        "module": "commonjs",          # Use CommonJS modules
        "outDir": "./out",             # Output directory for compiled JS
        "rootDir": "./src",            # Root directory of source files
        "esModuleInterop": true,       # Allow default imports from commonjs modules
        "forceConsistentCasingInFileNames": true, # Enforce consistent file casing
        "strict": true,                # Enable all strict type-checking options
        "skipLibCheck": true,          # Skip type checking of declaration files
        "emitDecoratorMetadata": true, # Needed for decorators (if used, e.g., with TypeDI or class-validator)
        "experimentalDecorators": true,# Enable experimental decorators
        "resolveJsonModule": true      # Allow importing JSON files
      },
      "include": ["src/**/*"],         # Files to include in compilation
      "exclude": ["node_modules", "**/*.test.ts"] # Files/dirs to exclude
    }
    ```

5.  **Nodemon Configuration (`nodemon.json`):**
    ```json
    {
      "watch": ["src"],                # Watch the src directory for changes
      "ext": "ts,json",              # Watch TypeScript and JSON files
      "ignore": ["src/**/*.spec.ts"], # Ignore test files
      "exec": "ts-node ./src/server.ts" # Command to execute on change
    }
    ```

6.  **ESLint Configuration (`eslint.config.mjs`):** Set up according to project standards, likely including `typescript-eslint` and potentially stylistic rules.

## Application Architecture

The application employs a layered architecture for separation of concerns:

1.  **Entry Point (`src/server.ts`, `src/app.ts`):** Initializes the Express app, sets up middleware, connects to the database, defines routes, and starts the server.
2.  **Routing (`src/routes/*.route.ts`):** Defines API endpoints and maps them to controller methods. Uses Express Router.
3.  **Controllers (`src/controllers/*.controller.ts`):** Handle incoming HTTP requests, parse request data (query params, body, etc.), call appropriate services, and formulate HTTP responses.
4.  **Services (`src/services/*.service.ts`):** Contain the core business logic, interact with the database (directly or via a data access layer), perform data manipulation, and validation logic not covered by DTOs.
5.  **Data Transfer Objects (`src/dto/*.dto.ts`):** Define the shape and validation rules (using Zod) for data moving between layers, especially request bodies.
6.  **Middleware (`src/middlewares/*.middleware.ts`):** Functions that execute during the request-response cycle for cross-cutting concerns like authentication, validation, logging, error handling, and file uploads.
7.  **Database (`src/database/*`):** Manages the database connection (using `pg`), runs queries, and handles migrations (`node-pg-migrate`).
8.  **Configuration (`src/config/index.ts`):** Loads and validates environment variables using `dotenv` and `envalid`.
9.  **Utilities (`src/utils/*`):** Reusable helper functions, like the Winston logger setup.
10. **Interfaces (`src/interfaces/*`):** TypeScript interfaces defining data structures and contracts between layers.
11. **Exceptions (`src/exceptions/*`):** Custom error classes for specific error handling scenarios.

## Environment Configuration

1.  **Create `.env` files:** Create files like `.env.development.local`, `.env.production.local`, `.env.test.local` in the project root.
2.  **Define Variables:** Populate these files with necessary environment variables. Key variables identified from `src/config/index.ts`:
    *   `NODE_ENV`: `development`, `test`, or `production`
    *   `PORT`: Server port (e.g., `8888`)
    *   `SECRET_TOKEN`: Secret key for JWT signing
    *   `DB_USER`: Database username
    *   `DB_PASSWORD`: Database password
    *   `DB_HOST`: Database host (e.g., `localhost`)
    *   `DB_PORT`: Database port (e.g., `5432`)
    *   `DB_NAME`: Database name (e.g., `recipe_api_dev`)
    *   `DB_DIALECT`: Database dialect (e.g., `postgresql`)
    *   `CREDENTIALS`: Boolean for CORS credentials (e.g., `true`)
    *   `ORIGIN`: Allowed CORS origins (e.g., `http://localhost:3000` or `*`)
    *   `LOG_FORMAT`: Morgan log format (e.g., `dev`)
    *   `LOG_DIR`: Directory for log files (e.g., `../logs`)

3.  **Validation:** The `src/config/index.ts` file uses `envalid` to validate these variables at runtime.

## Database Setup & Migrations

1.  **PostgreSQL:** Ensure a PostgreSQL server is running and accessible.
2.  **Database Creation:** Manually create the necessary databases (e.g., `recipe_api_dev`, `recipe_api_test`, `recipe_api_prod`) using a tool like `psql` or pgAdmin.
    ```sql
    CREATE DATABASE recipe_api_dev;
    -- CREATE DATABASE recipe_api_test; -- If needed for testing
    -- CREATE DATABASE recipe_api_prod; -- If needed for production
    ```
3.  **Connection:** The `src/database/index.ts` file configures and manages the connection using the `pg` client based on environment variables. It also attempts to run migrations automatically on connection.
4.  **Migrations (`node-pg-migrate`):**
    *   **Configuration:** Migration settings are likely defined implicitly or explicitly for `node-pg-migrate` (check `package.json` scripts or potentially a config file if not using defaults). The `src/database/migration.config.ts` and `src/database/migration.runner.ts` seem to provide a custom wrapper around `node-pg-migrate`.
    *   **Migration Files:** Located in the root `migrations/` directory (e.g., `migrations/1745144883049_recipe-db.ts`). These define schema changes (`up` function) and rollbacks (`down` function).
    *   **Key Tables (based on migrations):**
        *   `users`: Stores user information (id, name, email, password hash, timestamps).
        *   `recipes`: Stores core recipe data (id, title, description, image, chef, times, servings, difficulty, timestamps).
        *   `ingredients`: Stores recipe ingredients (id, recipe_id, name, amount, notes).
        *   `instructions`: Stores recipe steps (id, recipe_id, step_number, text).
        *   `recipe_photos`: Stores URLs or paths to recipe photos (id, recipe_id, photo_url, timestamps).
    *   **Running Migrations:** Use the npm scripts:
        *   `npm run migrate:create -- <migration_name>`: Create a new migration file.
        *   `npm run migrate:up`: Apply pending migrations.
        *   `npm run migrate:down`: Roll back the last applied migration.

## Core Implementation Details

### Server Entry Point (`server.ts`)
*   Imports the `App` class.
*   Imports route classes (`AuthRoute`, `RecipeRoute`).
*   Instantiates the `App` with the routes.
*   Calls `app.start()` to begin listening for connections.

### Application Setup (`app.ts`)
*   Initializes the `express` application.
*   Reads `PORT` and `NODE_ENV` from config.
*   **Middleware Initialization (`initializeMiddleware`):**
    *   `requestLoggerMiddleware`: Custom middleware (likely adds request ID).
    *   `morgan`: HTTP request logging using `LOG_FORMAT`.
    *   `cors`: Configured based on `ORIGIN` and `CREDENTIALS`. Handles preflight requests.
    *   `hpp`: Protects against parameter pollution.
    *   `helmet`: Sets various security headers (CSP disabled in dev).
    *   `compression`: Compresses responses.
    *   `express.json`, `express.urlencoded`: Parse JSON and URL-encoded bodies.
    *   `cookie-parser`: Parses cookies.
    *   `express-rate-limit`: Applies rate limiting (standard and stricter for auth routes).
    *   `express.static`: Serves static files from the `uploads` directory.
*   **Route Initialization (`initializeRoutes`):**
    *   Adds a `/health` check endpoint.
    *   Iterates through provided route instances and mounts their routers under the `/api` prefix.
*   **Swagger Initialization (`initializeSwagger`):**
    *   Configures `swagger-jsdoc` to scan routes and DTOs for JSDoc comments.
    *   Sets up `swagger-ui-express` to serve the interactive API documentation at `/api-docs`.
*   **Database Connection (`connectToDatabase`):** Calls the `connectDB` function from `src/database/index.ts`.
*   **Error Handling (`initializeErrorHandling`):**
    *   Adds a 404 handler for unmatched routes.
    *   Registers the main `ErrorMiddleware`.
*   **Server Start (`start`):** Listens on the configured port and logs server information. Includes graceful shutdown logic for `SIGTERM` and `SIGINT`.

### Configuration (`config/index.ts`)
*   Uses `dotenv` to load the appropriate `.env.*.local` file based on `NODE_ENV`.
*   Uses `envalid` to define the expected environment variables, their types, and validation rules (e.g., choices, defaults).
*   Exports the validated and cleaned environment variables for use throughout the application.

### Authentication System
*   **Routes (`src/routes/auth.route.ts`):** Defines endpoints under `/api/auth` (e.g., `/signup`, `/login`, `/logout`, `/me`, `/verify-token`). Uses `validateMiddleware` for DTO validation and `AuthMiddleware` for protected routes. Includes Swagger JSDoc annotations.
*   **Controller (`src/controllers/auth.controller.ts`):** Handles requests, extracts data, calls `AuthService`, and sends responses (user data, tokens via cookies/body).
*   **Service (`src/services/auth.service.ts`):** Implements the core logic:
    *   User creation (hashing passwords with `bcrypt`).
    *   User lookup by email.
    *   Password comparison (`bcrypt.compare`).
    *   JWT generation (`jsonwebtoken.sign`) using `SECRET_TOKEN`.
    *   JWT verification.
*   **Middleware (`src/middlewares/auth.middleware.ts`):** Verifies the JWT token (likely from `Authorization` header or cookies), finds the user, and attaches user data to the `req` object (extending `Express.Request` via `src/types/express.d.ts`). Throws an `HttpException` if authentication fails.
*   **DTOs (`src/dto/user.dto.ts`):** Defines `SignupUserDtoType` and `LoginUserDtoType` using Zod for validating request bodies.
*   **Interfaces (`src/interfaces/auth.interface.ts`, `src/interfaces/user.interface.ts`):** Define shapes for tokens, request data, and user objects.

### Recipe Management System
*   **Routes (`src/routes/recipe.route.ts`):** Defines endpoints under `/api/recipes` for CRUD operations on recipes, ingredients, instructions, and photos. Uses `AuthMiddleware` for protection, `validateMiddleware` for DTOs, and `uploadPhotoMiddleware`/`uploadPhotosMiddleware` for file uploads. Includes Swagger JSDoc annotations.
*   **Controller (`src/controllers/recipe.controller.ts`):** Handles requests, extracts recipe IDs, user data (from `req.user`), and request bodies/files. Calls `RecipeService` and formats responses.
*   **Service (`src/services/recipe.service.ts`):** Implements the core logic:
    *   Fetching all recipes, featured recipes, specific recipes by ID.
    *   Creating, updating, and deleting recipes.
    *   Managing ingredients and instructions associated with recipes.
    *   Handling recipe photo uploads (saving file info/paths to the database) and deletions.
    *   Interacts directly with the database client (`src/database/index.ts`) using SQL queries (potentially using `pg-format`).
*   **Middleware (`src/middlewares/upload.middleware.ts`):** Configures `multer` for handling `multipart/form-data` requests. Defines storage location (`uploads/`), file naming conventions, size limits, and file filters (e.g., for image types). Exports middleware for single (`uploadPhotoMiddleware`) and multiple (`uploadPhotosMiddleware`) file uploads.
*   **DTOs (`src/dto/recipe.dto.ts`):** Defines `CreateRecipeDtoType` and `UpdateRecipeDtoType` using Zod for validating recipe data in request bodies. Also likely includes DTOs for ingredients and instructions if they are created/updated via specific endpoints or nested within recipe DTOs.
*   **Interfaces (`src/interfaces/recipe.interface.ts`):** Define shapes for Recipe, Ingredient, Instruction, and Photo objects.

### Middleware Implementation
*   **Validation (`src/middlewares/validation.middleware.ts`):** A generic middleware that takes a Zod schema and validates either the request `body`, `query`, or `params`. If validation fails, it throws an `HttpException` with details.
*   **Error (`src/middlewares/error.middleware.ts`):** Catches errors passed via `next(error)`, logs the error, and sends a standardized JSON error response. Handles custom `HttpException` and generic errors.
*   **Authentication (`src/middlewares/auth.middleware.ts`):** Described in the Authentication section.
*   **Upload (`src/middlewares/upload.middleware.ts`):** Described in the Recipe Management section.
*   **Request Logger:** A custom middleware likely added in `app.ts` to assign a unique ID to each request for tracing purposes.

### Error Handling
*   **Custom Exception (`src/exceptions/httpException.ts`):** A custom error class extending `Error` that includes an HTTP status code and a message. Used throughout the application to signal specific error conditions (e.g., Not Found, Bad Request, Unauthorized).
*   **Error Middleware (`src/middlewares/error.middleware.ts`):** Centralized error handling logic. Catches errors, logs them using the Winston logger, and sends appropriate JSON responses to the client, hiding sensitive stack traces in production.
*   **Validation Middleware:** Catches validation errors from Zod and converts them into 400 Bad Request `HttpException`s.
*   **404 Handler:** A final middleware in `app.ts` catches requests that don't match any defined routes and sends a 404 Not Found response.

### Logging
*   **Winston Setup (`src/utils/logger.ts`):**
    *   Configures Winston logger instance.
    *   Uses `winston.format` for log formatting (timestamps, log level, message).
    *   Sets up transports:
        *   `winston.transports.Console`: Logs to the console (conditionally formatted, possibly only in development).
        *   `winston-daily-rotate-file`: Logs to files in the `LOG_DIR` (`logs/debug/` and `logs/error/`), rotating them daily and potentially compressing old logs. Separates logs by level (e.g., `info` and above to one file, `error` to another).
    *   Exports the configured `logger` instance and a `stream` object compatible with `morgan`.
*   **Morgan Integration:** `morgan` middleware in `app.ts` uses the Winston `stream` to pipe HTTP request logs through the Winston logger.
*   **Usage:** The `logger` instance is imported and used throughout the application (services, controllers, error handler) for logging events, errors, and debug information.

## API Documentation (Swagger)

*   **Setup:** Configured within `src/app.ts` using `swagger-jsdoc` and `swagger-ui-express`.
*   **Definition:** `swagger-jsdoc` generates the OpenAPI specification by parsing JSDoc comments in route files (`src/routes/*.ts`) and potentially DTO files (`src/dto/*.ts`).
*   **Annotations:** Route files contain `@swagger` tags to define paths, operations, parameters, request bodies, responses, security schemes (Bearer Auth), and schemas (referencing DTOs or defining inline).
*   **UI:** `swagger-ui-express` serves the interactive documentation UI at the `/api-docs` endpoint.

## Running the Application

Use the scripts defined in `package.json`:

1.  **Development:**
    ```bash
    npm run dev
    ```
    Starts the server using `nodemon` and `ts-node`, automatically restarting on file changes. Loads `.env.development.local`.

2.  **Build for Production:**
    ```bash
    npm run build
    ```
    Compiles TypeScript code from `src/` to JavaScript in `out/` using `tsc`.

3.  **Run Production:**
    ```bash
    npm start
    ```
    Runs the compiled JavaScript code from `out/server.js` using `node`. Ensure `NODE_ENV=production` is set and `.env.production.local` exists.

4.  **Linting:**
    ```bash
    npm run lint
    ```
    Runs ESLint to check for code style and potential errors.

5.  **Migrations:**
    ```bash
    npm run migrate:create -- <migration_name> # Create new migration
    npm run migrate:up                       # Apply migrations
    npm run migrate:down                     # Rollback last migration
    ```

## Utility Scripts

*   **`src/scripts/create-migration.ts`:** Script executed by `npm run migrate:create`. Likely uses `node-pg-migrate` programmatically or via shell command to generate a new timestamped migration file in the `migrations/` directory.
*   **`src/scripts/run-migrations.ts`:** Script executed by `npm run migrate:up` and `npm run migrate:down`. Uses the custom migration runner (`src/database/migration.runner.ts`) to apply or rollback migrations.
*   **`src/scripts/populate-ghanaian-recipes.ts`:** A custom script to seed the database with initial recipe data (likely specific to Ghanaian recipes). Needs to be run manually (e.g., `ts-node src/scripts/populate-ghanaian-recipes.ts`).
*   **`src/utils/test-db-connection.ts`:** A utility script to quickly test if the database connection configured via environment variables is working. Run manually (e.g., `ts-node src/utils/test-db-connection.ts`).

This guide covers all identified aspects of the Recipe API application. Following these steps should allow for a successful recreation.
